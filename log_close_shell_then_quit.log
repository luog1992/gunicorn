# å¯åŠ¨ä¸€ä¸ªworker, ç„¶åŽå…³é—­ç»ˆç«¯, æœ€åŽä½¿ç”¨kill -QUITæ€æ­»è¿›ç¨‹

# å¯åŠ¨master
[65871] [INFO] [39m     {140735730451328} proc_name: app:app
[65871] [INFO] [39m     {140735730451328} run
[65871] [INFO] Starting gunicorn 20.0.0
[65871] [INFO] [39m     {140735730451328} init_signals
[65871] [INFO] Listening at: http://127.0.0.1:8000 (65871)
[65871] [INFO] Using worker: sync
[65871] [INFO] [39m     {140735730451328} spawn_workers
[65871] [INFO] [39m     {140735730451328} SP_WKS> spawn_worker
[65871] [INFO] [39m     {140735730451328} spawn_worker before fork
[65871] [INFO] [39m     {140735730451328} spawn_worker after fork

# å¯åŠ¨worker
[65874] [INFO] [36m     {140735730451328} spawn_worker after fork
[65874] [INFO] Booting worker with pid: 65874
[65874] [INFO] [36m >>> {140735730451328} spawn_worker before worker init_process
[65874] [INFO] [36m >>> {140735730451328} init_process
[65874] [INFO] [36m >>> {140735730451328} init_signals
[65874] [INFO] [36m >>> {140735730451328} load_wsgi

# âš ï¸ å…³é—­ç»ˆç«¯

# todo: ä¸ºå•¥æ”¶åˆ°äº†ä¸¤æ¬¡SIGHUPðŸ“¶?
[65871] [INFO [39m     {140735730451328} signal sig=1 & wakeup
[65871] [INFO] [39m     {140735730451328} SIG1> wakeup
[65871] [INFO] [39m     {140735730451328} signal sig=1 & wakeup
[65871] [INFO] [39m     {140735730451328} SIG1> wakeup
[65871] [INFO] [39m     {140735730451328} sleep except [Errno 35] Resource temporarily unavailable

# å¤„ç†ç¬¬ä¸€ä¸ª SIGHUPðŸ“¶
[65871] [INFO] [39m     {140735730451328} run got sig=1                        # âŒ
[65871] [INFO] [39m     {140735730451328} handle_hup & reload
[65871] [INFO] [39m     {140735730451328} reload

# workeré€€å‡º, ä¸ºä»€ä¹ˆworkerä¸­æ²¡æœ‰è®°å½•æ”¶åˆ°SIGHUPçš„æ—¥å¿—?
[65871] [INFO] [39m     {140735730451328} handle_chld & reap_workers & wakeup
[65871] [INFO] [39m     {140735730451328} H_CHLD> reap_workers
[65871] [INFO] [39m     {140735730451328} H_CHLD> wakeup

# é‡æ–°spawn workers
[65871] [INFO] [39m     {140735730451328} RELOAD> spawn_worker
[65871] [INFO] [39m     {140735730451328} spawn_worker before fork
[65871] [INFO] [39m     {140735730451328} spawn_worker after fork              # âœ”ï¸

[65871] [INFO] [39m     {140735730451328} run will wakeup  # æ­¤å¤„æŽ¥ âŒ
[65871] [INFO] [39m     {140735730451328} RUN> wakeup

# å¤„ç†ç¬¬äºŒä¸ª SIGHUP
[65871] [INFO] [39m     {140735730451328} run got sig=1
[65871] [INFO] [39m     {140735730451328} handle_hup & reload
[65871] [INFO] [39m     {140735730451328} reload                               # â¤ï¸

# âœ”ï¸ å¤„å¯åŠ¨çš„worker
[65901] [INFO] [32m     {140735730451328} spawn_worker after fork
[65901] [INFO] Booting worker with pid: 65901
[65901] [INFO] [32m +++ {140735730451328} spawn_worker before worker init_process
[65901] [INFO] [32m +++ {140735730451328} init_process
[65901] [INFO] [32m +++ {140735730451328} init_signals
[65901] [INFO] [32m +++ {140735730451328} load_wsgi

[65871] [INFO] [39m     {140735730451328} RELOAD> spawn_worker     # æ­¤å¤„æŽ¥ â¤ï¸
[65871] [INFO] [39m     {140735730451328} spawn_worker before fork
[65871] [INFO] [39m     {140735730451328} spawn_worker after fork              # ðŸ€

# ðŸ€ å¤„å¯åŠ¨æ–°çš„worker, ç„¶åŽkilläº† âœ”ï¸ å¤„å¯åŠ¨çš„worker? ä¸ºå•¥å­è¦è¿™ä¹ˆæžå˜ž?
[65871] [INFO] [39m     {140735730451328} MN_WKS> kill_worker pid=65901 Signals.SIGTERM
## [65871] [INFO] [39m     {140735730451328} run will wakeup
## [65871] [INFO] [39m     {140735730451328} RUN> wakeup
[65901] [INFO] [32m +++ {140735730451328} handle_exit: 15
[65871] [INFO] [39m     {140735730451328} sleep except [Errno 35] Resource temporarily unavailable
[65871] [INFO] [39m     {140735730451328} MN_WKS> kill_worker pid=65901 Signals.SIGTERM
[65901] [INFO] [32m +++ {140735730451328} handle_exit: 15

# ðŸ€ å¤„æ–°å¯åŠ¨çš„worker
[65902] [INFO] [34m     {140735730451328} spawn_worker after fork
[65902] [INFO] Booting worker with pid: 65902
[65902] [INFO] [34m *** {140735730451328} spawn_worker before worker init_process
[65902] [INFO] [34m *** {140735730451328} init_process
[65902] [INFO] [34m *** {140735730451328} init_signals
[65902] [INFO] [34m *** {140735730451328} load_wsgi

# âœ”ï¸ å¤„å¯åŠ¨çš„workeré€€å‡º
[65901] [INFO] [32m +++ {140735730451328} spawn_worker after worker init_process
[65901] [INFO] [32m +++ {140735730451328} spawn_worker except SystemExit
[65901] [INFO] [32m +++ {140735730451328} spawn_worker finally worker exiting
[65901] [INFO] Worker exiting (pid: 65901)
[65901] [INFO] [32m     {140735730451328} run except3: SystemExit

# masterå¤„ç† âœ”ï¸ å¤„workerçš„é€€å‡º
[65871] [INFO] [39m     {140735730451328} handle_chld & reap_workers & wakeup
[65871] [INFO] [39m     {140735730451328} H_CHLD> reap_workers
[65871] [INFO] [39m     {140735730451328} H_CHLD> wakeup
[65871] [INFO] [39m     {140735730451328} sleep except [Errno 35] Resource temporarily unavailable

# âš ï¸ ä½¿ç”¨ kill -QUIT é€€å‡ºè¿›ç¨‹

# æ”¶åˆ° SIGQUITðŸ“¶
[65871] [INFO] [39m     {140735730451328} signal sig=3 & wakeup
[65871] [INFO] [39m     {140735730451328} SIG3> wakeup
[65871] [INFO] [39m     {140735730451328} sleep except [Errno 35] Resource temporarily unavailable
[65871] [INFO] [39m     {140735730451328} run got sig=3
[65871] [INFO] [39m     {140735730451328} handle_quit & stop & StopIteration   # ðŸ‘ 
# è°ƒç”¨ stop
[65871] [INFO] [39m     {140735730451328} H_QUIT> stop graceful=False
[65871] [INFO] [39m     {140735730451328} stop will SIGQUIT workers            # ðŸ˜ˆ
[65871] [INFO] [39m     {140735730451328} H_QUIT>STOP> kill_workers: Signals.SIGQUIT
[65871] [INFO] [39m     {140735730451328} H_QUIT>STOP>KL_WKS> kill_worker pid=65902 Signals.SIGQUIT
# workeré€€å‡º
[65902] [INFO] [34m *** {140735730451328} handle_quit: 3 sys.exit(0)
[65902] [INFO] [34m *** {140735730451328} spawn_worker except SystemExit
[65902] [INFO] [34m *** {140735730451328} spawn_worker finally worker exiting
[65902] [INFO] Worker exiting (pid: 65902)
[65902] [INFO] [34m     {140735730451328} run except3: SystemExit
# master å¤„ç† worker é€€å‡º
[65871] [INFO] [39m     {140735730451328} handle_chld & reap_workers & wakeup
[65871] [INFO] [39m     {140735730451328} H_CHLD> reap_workers
[65871] [INFO] [39m     {140735730451328} H_CHLD> wakeup

[65871] [INFO] [39m     {140735730451328} stop will SIGKILL workers    # æ­¤å¤„æŽ¥ ðŸ˜ˆ
[65871] [INFO] [39m     {140735730451328} H_QUIT>STOP> kill_workers: Signals.SIGKILL

[65871] [INFO] [39m     {140735730451328} run except1: StopIteration   # ðŸ‘  å¤„çš„å¼‚å¸¸
[65871] [INFO] [39m     {140735730451328} RUN> halt reason=None exit_status=0
[65871] [INFO] [39m     {140735730451328} RUN>HALT> stop graceful=True
[65871] [INFO] [39m     {140735730451328} stop will SIGTERM workers
[65871] [INFO] [39m     {140735730451328} RUN>HALT>STOP> kill_workers: Signals.SIGTERM
[65871] [INFO] [39m     {140735730451328} stop will SIGKILL workers
[65871] [INFO] [39m     {140735730451328} RUN>HALT>STOP> kill_workers: Signals.SIGKILL
[65871] [INFO]      {140735730451328} Shutting down Master

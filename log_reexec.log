# reexec è¿‡ç¨‹åˆ†æž

# å¯åŠ¨master
[8251] [INFO] [39m     {140736046486400} setup
[8251] [INFO] [39m     {140736046486400} setup proc_name: app:app
[8251] [INFO] [39m     {140736046486400} START_CTX: {'args': ['/Users/xianyu/prjs/gunicorn/.venv/bin/python3.7', '/Users/xianyu/prjs/gunicorn/.venv/bin/gunicorn', '-w', '1', '-k', 'sync', '--error-logfile', '.error.log', 'app:app'], 'cwd': '/Users/xianyu/prjs/gunicorn', 0: '/Users/xianyu/prjs/gunicorn/.venv/bin/python3.7'}
[8251] [INFO] [39m     {140736046486400} run
[8251] [INFO] [39m     {140736046486400} start Starting gunicorn 20.0.0
# ðŸº åˆå§‹çš„ master_pid reexec_pid éƒ½æ˜¯ 0
[8251] [INFO] [39m     {140736046486400} start master Master master_pid=0 reexec_pid=0
[8251] [INFO] [39m     {140736046486400} init_signals
[8251] [INFO] [39m     {140736046486400} create listeners fds=None
[8251] [INFO] [39m     {140736046486400} Listening at: http://127.0.0.1:8000 (8251)
[8251] [INFO] [39m     {140736046486400} Using worker: sync
[8251] [INFO] [39m     {140736046486400} spawn_workers
[8251] [INFO] [39m     {140736046486400} SP_WKS> spawn_worker
[8251] [INFO] [39m     {140736046486400} spawn_worker before fork
[8251] [INFO] [39m     {140736046486400} spawn_worker after fork

# å¯åŠ¨worker
[8256] [INFO] [32m     {140736046486400} spawn_worker after fork
[8256] [INFO] [32m     {140736046486400} Booting worker with pid: 8256
[8256] [INFO] [32m +++ {140736046486400} spawn_worker before worker init_process
[8256] [INFO] [32m +++ {140736046486400} init_process
[8256] [INFO] [32m +++ {140736046486400} init_signals
[8256] [INFO] [32m +++ {140736046486400} load_wsgi

[8251] [INFO] [39m     {140736046486400} promote master master_pid=0
[8251] [INFO] [39m     {140736046486400} promote master master_pid=0

# æ”¶åˆ° SIGUSR2ðŸ“¶
[8251] [INFO] [39m     {140736046486400} signal sig=31 & wakeup
[8251] [INFO] [39m     {140736046486400} SIG31> wakeup

## [8251] [INFO] [39m     {140736046486400} sleep except [Errno 35] Resource temporarily unavailable
## [8251] [INFO] [39m     {140736046486400} promote master master_pid=0

# è°ƒç”¨ reexec ðŸ‘
[8251] [INFO] [39m     {140736046486400} run got sig=31
[8251] [INFO] [39m     {140736046486400} Handling signal: usr2                 # ðŸŒ²
[8251] [INFO] [39m     {140736046486400} handle_usr2 & reexec
[8251] [INFO] [39m     {140736046486400} reexec                                # ðŸ’„

[8251] [INFO] [39m     {140736046486400} run will wakeup   # æ­¤å¤„æŽ¥ ðŸŒ²
[8251] [INFO] [39m     {140736046486400} RUN> wakeup

# åœ¨ reexec ä¹‹å‰, master_pid==0
[8251] [INFO] [39m     {140736046486400} promote master master_pid=0
[8251] [INFO] [39m     {140736046486400} sleep except [Errno 35] Resource temporarily unavailable

# æŽ¥è¿™ ðŸ’„, reexec æ—¶ fork äº§ç”Ÿæ–°è¿›ç¨‹ 8270 ðŸ€
[8270] [INFO] [31m     {140736046486400} reexec master_pid=8251
[8270] [INFO] [31m     {140736046486400} reexec reexec_pid=0
[8270] [INFO] [31m     {140736046486400} reexec will execvpe

# reexec => setup
[8270] [INFO] [39m     {140736046486400} setup
[8270] [INFO] [39m     {140736046486400} setup proc_name: app:app
[8270] [INFO] [39m     {140736046486400} START_CTX: {'args': ['/Users/xianyu/prjs/gunicorn/.venv/bin/python3.7', '/Users/xianyu/prjs/gunicorn/.venv/bin/gunicorn', '-w', '1', '-k', 'sync', '--error-logfile', '.error.log', 'app:app'], 'cwd': '/Users/xianyu/prjs/gunicorn', 0: '/Users/xianyu/prjs/gunicorn/.venv/bin/python3.7'}

# reexec => run
[8270] [INFO] [39m     {140736046486400} run
[8270] [INFO] [39m     {140736046486400} start Starting gunicorn 20.0.0

# â—ï¸ï¸æ­¤å¤„ master_pid != 0
[8270] [INFO] [39m     {140736046486400} start master Master.2 master_pid=8251 reexec_pid=0
[8270] [INFO] [39m     {140736046486400} init_signals
[8270] [INFO] [39m     {140736046486400} create listeners fds=[6]

# ðŸ€ reexec äº§ç”Ÿçš„æ–°è¿›ç¨‹ é€€å‡ºðŸ’¥, ç„¶åŽ master è¿›ç¨‹æ”¶åˆ°ä¿¡å·å¹¶å¤„ç†
[8251] [INFO] [39m     {140736046486400} handle_chld & reap_workers & wakeup
[8251] [INFO] [39m     {140736046486400} H_CHLD> reap_workers
# todo: â“ï¸ æ­¤å¤„ master_pid æ€Žä¹ˆç­‰äºŽ 0 äº†? ç†è®ºä¸Šåªæœ‰ maybe_promote_master ä¼šä¿®æ”¹ master_id, ä½†æ˜¯æ²¡æœ‰ç›¸å…³çš„æ—¥å¿—!!
[8251] [INFO] [39m     {140736046486400} H_CHLD> reap_workers wpid=8270 reexec_pid=8270 master_pid=0
[8251] [INFO] [39m     {140736046486400} H_CHLD> wakeup

[8251] [INFO] [39m     {140736046486400} sleep except [Errno 35] Resource temporarily unavailable

[8251] [INFO] [39m     {140736046486400} promote master master_pid=0
